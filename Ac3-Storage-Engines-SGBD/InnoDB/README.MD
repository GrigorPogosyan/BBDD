# InnoDB<img align="right" width="200" src="../imatges/innodb_logo.png"/>
## Connexi√≥ per SSH al Sistema
Primer de tot, ens connectarem a la m√†quina per **SSH** desde CMD (ho tenim pr√®viament instal¬∑lat).
```
ssh machineuser@ip 
```
<details open>
<summary><b>Connexi√≥ per SSH</b></summary>
<img src="captures/ssh.png">
</details>

<hr>

## Desactivar opci√≥  innodb_file_per_table
Aquesta opci√≥ en els SGBD actuals ve per defecte activat, i la seva funci√≥ √©s que per cada taula creada de la meva base de dades tindr√† el seu propi Table Space, √©s a dir cada taula tindr√† el seu propi fitxer de dades que aquest cont√© tota la informaci√≥ de la taula, son fitxers .ibd

Per desactivar aquesta opci√≥ i dir que ara no volem un fitxer per cada taula, sin√≥ un fitxer per totes les taules haurem de desactivar aquesta opci√≥.

Lo primer que hem de fer √©s anar al nostre fitxer de configuraci√≥ de MySQL i afegir el seg√ºent par√†metre en OFF: `innodb_file_per_table=OFF`

```
# nano /etc/my.cnf
```
```
[mysqld]
innodb_file_per_table=OFF
```
<details open>
<summary><b>Desactivar innodb_file_per_table</b></summary>
<img src="captures/ssh.png">
</details>

Guardarem els canvis i reiniciarem el Servei de MySQLD.

```
# systemctl restart mysqld && systemctl status mysqld
```
<details open>
<summary><b>Reiniciar i veure l'estat del Servei</b></summary>
<img src="captures/restart_status.png">
</details>

Ara comprovarem que est√† desactivat consultant-ho a la variable des del MySQL.
```
mysql> SHOW VARIABLES LIKE '%file_per%';
```
<details open>
<summary><b>Verificar que l'hem desactivat</b></summary>
<img src="captures/status_file_per_table.png">
</details><br>

## Permisos, Usuari i Grup de la carpeta Datadir
Ara, veurem els permisos, l'usuari i el grup de la carpeta del directori de dades (datadir).

Si no sabem quin √©s el nostre directori de dades, tamb√© el podrem consultar via SQL.
```
mysql> SHOW VARIABLES LIKE '%datadir%';
```
<details open>
<summary><b>Consultar el nostre directori de dades</b></summary>
<img src="captures/show_datadir.png">
</details>

En aquest cas la ruta del path del directori de dades √©s `/var/lib/mysql`.

Per veure els permisos el usuari i el grup d'aquesta carpeta fariem lo seg√ºent:
```
# ls -alis /var/lib/mysql
```
<details open>
<summary><b>Veure permisos, usuari i grup del directori de dades</b></summary>
<img src="captures/ls_alis_var_lib_mysql.png">
</details>

Veient aix√≤ podem arribar a la seg√ºent conclusi√≥.

- Propietari del directori ‚û°Ô∏è‚Äã `mysql` (usuari)
- Grup del directori ‚û°Ô∏è‚Äã `mysql` (grup)
* Permisos:
    - Permisos per el propietari (`mysql`) ‚û°Ô∏è‚Äã RWX (lectura, escriptura i execuci√≥)
    - Permisos per el grup (`mysql`) ‚û°Ô∏è‚Äã RX (lectura i execuci√≥)
    - Altres ‚û°Ô∏è‚Äã X (Execuci√≥)
<br><br>

## Mida System TableSpace
Per veure la mida del nostre System TableSpace (fitxers ibdata), primer hem de saber on estan localitzats en el nostre SO. Per saber-ho, ho farem mitjan√ßant una consulta SQL.
```
mysql> SHOW VARIABLES LIKE 'innodb_data_file_path';
```
<details open>
<summary><b>Saber la ruta per defecte del nostre System TableSpace i la mida inicial</b></summary>
<img src="captures/innodb_data_file_path.png">
</details>

El value anterior, indica que dins de la carpeta de MySQL, hi ha un fitxer que es diu `ibdata1`, i que de mida inicial t√© `12M`, reservar√† aquests 12M inicials aquest arxiu.

Tamb√© ho podem comprovar la mida des del directori.
```
# ls -lh /var/lib/mysql/ibdata1
```
<details open>
<summary><b>Mida del arxiu ibdata1</b></summary>
<img src="captures/ibdata1_size.png">
</details>

T√© aquests 12M inicials, per√≤ quan s'omplin anir√†, en aquests 12M se li sumar√† la mida del valor del par√†metre `innodb_autoextend_increment`. Que per defecte son `64M`, llavors en total tindriem `76M` i en cas de que s'ompli aquesta mida, es tornaria a sumar a la mida `64M` que √©s el que tenim configurat en el par√†metre `innodb_autoextend_increment`, d'aquesta manera succesivament anir√† creixent la mida del fitxer. I a m√©s d'aquesta manera, estarem estalviant espai en el nostre disc, i no pas reservant des d'un principi 100M o el que pensem que ens faria falta.

```
mysql> SHOW VARIABLES LIKE 'innodb_autoextend_increment';
```
<details open>
<summary><b>Consultar la mida en Megabytes que se li sumar√† a cada fitxer configurat amb autoextend.</b></summary>
<img src="captures/innodb_autoextend_increment.png">
</details>
En resum t√© aquesta mida perqu√® est√† definida en la variable, i funciona d'aquesta manera, per no comen√ßar a reservar 10000M de cop quan realment no ens fa falta. Per aix√≤ est√† el autoextend que √©s el que far√† que el nostre fitxer augmenti de mida.

## Importar BD Sakila com a taules InnoDB
Ara, importarem la BD Sakila que ens proporciona MySQL per fer proves com a taules InnoDB.

Tenim sort i MySQL ja ha definit l'engine a cada sent√®ncia de creaci√≥ de taules i ens ha estalviat feina, no obstant aix√≤ hi ha taula/les que no tenen definit cap Storage Engine i aix√≤ vol dir que en les taules que no hi ha especificat el Storage Engine utilitzaria el Storage Engine per defecte que tenim configurat en el nostre SGBD.

Llavors el que farem ser√† posar InnoDB com a Storage Engine per defecte.
```
# nano /etc/my.cnf
```
```
[mysqld]
default-storage-engine=InnoDB
```
<details open>
<summary><b>InnoDB default Storage Engine</b></summary>
<img src="captures/innodb_default.png">
</details>

I seguit reiniciariem el servei de MySQL
```
# systemctl restart mysqld && systemctl status mysqld
```
<details open>
<summary><b>Reiniciar i veure l'estat del Servei</b></summary>
<img src="captures/restart_status.png">
</details>

Ara, ja tenim configurat InnoDB com al motor d'emmagatzematge per defecte, ara hem de descarregar-nos la BD Sakila [d'aquesta p√†gina](https://dev.mysql.com/doc/index-other.html)

<details open>
<summary><b>P√†gina per descarregar Sakila</b></summary>
<img src="captures/sakila_page.png">
</details>

Nosaltres des de linux, farem un `wget` per descarregar-ho.
```
# wget https://downloads.mysql.com/docs/sakila-db.tar.gz
```
<details open>
<summary><b>Descarregar Sakila</b></summary>
<img src="captures/wget_sakila.png">
</details>

Ara, descomprimirem el .tar.gz obtingut de Sakila
```
# tar xzvf sakila-db.tar.gz
```
<details open>
<summary><b>Descomprimir Sakila</b></summary>
<img src="captures/tar_sakila.png">
</details>

Ara mirarem les sent√®ncies DDL sakila-schema.sql del Sakila que √©s el que ens interessa, per veure si hi ha alguna contradicci√≥ de Storage Engine, perqu√® volem que tot estigui en InnoDB.

Al fer la seg√ºent comprovaci√≥ podem veure que una taula no t√© especificat el Storage Engine, (tamb√© podem mirar-ho manualment en el fitxer).
```
# cat sakila-db/sakila-schema.sql | grep "CREATE TABLE" -c
16
# cat sakila-db/sakila-schema.sql | grep "ENGINE=InnoDB" -c
15
```
<details open>
<summary><b>Comparaci√≥ de sent√®ncies CREATE TABLE i veure si tenen especificat Engine</b></summary>
<img src="captures/grep_count.png">
</details>

Si revisem el fitxer manualment, podrem veure quina taula √©s. Si no especifica l'engine utilitzar√† el que t√© per defecte el SGBD des del qual s'importa la BD.
Per√≤ si ens fixem b√©, ells canviem la variable global del Storage Engine per defecte a MyIsam abans d'executar la taula on no t√© definida cap Storage Engine, i encara nosaltres tinguem definits a nivell de configuraci√≥ que per defecte √©s InnoDB, en el fitxer es modifica aquesta variable per MyISAM, llavors hem de treure aquesta linea o especificar el Storage Engine InnoDB en aquesta taula.

Millor definir-lo en la sent√®ncia DDL.

```
Engine = InnoDB
```

<details open>
<summary><b>Com es veuria abans d'especificar InnoDB</b></summary>
<img src="captures/abans_posar.png">
</details>
<details open>
<summary><b>Com es veuria despr√©s d'especificar InnoDB</b></summary>
<img src="captures/despres_posar.png">
</details>

Ara quan sabem que tenim totes les taules amb el Storage Engine InnoDB, procedirem a importar-les en el nostre MySQL.

Entrarem a MySQL en local, i importarem el Schema. I les dades del Schema
```
mysql> SOURCE /root/sakila-db/sakila-schema.sql
```
<details open>
<summary><b>Importar BD Sakila (Schema)</b></summary>
<img src="captures/import_sakila_schema.png">
</details>

```
mysql> SOURCE /root/sakila-db/sakila-data.sql
```
<details open>
<summary><b>Importar BD Sakila (Data)</b></summary>
<img src="captures/import_sakila_data.png">
</details>

I ja ho tindriem importat

## Fitxers de dades, Ruta i Mida
Ara, com tenim el par√†metre `innodb_file_per_table` desactivat, ja no crea fitxers per cada taula de BD, ara les crea tot en un √∫nic fitxer juntament amb els altres BD. 
Antigament, si anessim a `/var/lib/mysql/sakila` veuriem els diferents fitxers en format .ibd de les diferents taules, per√≤ ara estar√† buit aquesta carpeta i tot ho tindrem en el fitxer ibdata1 en binari, on la seva ruta completa seria `/var/lib/mysql/ibdata1`.

Si mirem la ruta `/var/lib/mysql/sakila` podrem veure que est√† buida.
```
mysql> SOURCE /root/sakila-db/sakila-data.sql
```
<details open>
<summary><b>Verificar que ja no crea els .ibd</b></summary>
<img src="captures/sakila_buit.png">
</details>

I si mirem ara el fitxer ibdata1 que √©s on es guarda tota la informaci√≥ de totes les bases de dades podrem veure que ha crescut, i el autoextend li ha sumat els `64M` que tenia configurat per defecte. Ara el fitxer t√© `76M` reservats, aix√≤ vol dir que ha superat els `12M` inicials.

<details open>
<summary><b>Veure que ha crescut la mida del nostre System TableSpace ibdata1 degut a les importacions de dades anteriors</b></summary>
<img src="captures/alish_ibda.png">
</details>

## Canviar la configuraci√≥ de dades de MySQL
En aquest apartat farem els seg√ºents canvis en el nostre MySQL.

> - Canviar la localitzaci√≥ del directori de dades.
>- Tenir 2 fitxers de System Tablespace complint lo seg√ºent:
>   - Tots 2 fitxers amb 50MB de mida inicial.
>   - El tablespace ha de cr√©ixer de 5MB en 5MB
>       - Situarem aquests fitxers en un disc diferent cadascun que insertarem i montarem en la nostra m√†quina vitual

### Canviar Localitzaci√≥ del directori de Dades
En aquest punt canviarem la localitzaci√≥ de dades del MySQL a la ruta `/hd-mysql`, √©s a dir a l'arrel. Ho farem sense passar els arxius de l'antiga ruta, farem que ho torni a generar ell.

Llavors crearem el directori.
```
# mkdir /hd-mysql/
```
<details open>
<summary><b>Crear el directori</b></summary>
<img src="captures/mkdir_hdmysql.png">
</details>

Ara, hem de posar els permisos corresponents al directori per a que MySQL pugui accedir correctament i no tingui cap problema. Els permisos chmod 751, volen dir RWX al propietari RX al grup i X als altres.

```
# chown -R mysql:mysql /hd-mysql
# chmod 751 /hd-mysql
```
<details open>
<summary><b>Permisos del nou directori del MySQL</b></summary>
<img src="captures/permisos_hd-mysql.png">
</details>

Ara, procedirem a canviar el directori de dades del MySQL des del fitxer de configuraci√≥ `/etc/my.cnf`. Haurem de tocar els par√†metres `datadir` i `datadir` i deixar els par√†metres `log-error` i `pid-file` tal com ens venen per defecte. Aquests par√†metres els posarem a sota del `[mysqld]`. Els par√†metres que fan refer√®ncia per exemple a MyRocks que l'hem hagut d'instal¬∑lar, les hem de treure perqu√® al canviar de directori i generar nous fitxers de configuraci√≥ les instal¬∑lacions externes que hem fet per exemple del MyRocks els perdriem. 

Tamb√©, en la primera vegada que hem de reiniciar el servei del MySQL per a que ens generi tota l'estructura de fitxers, bd etc... Hem de tenir el my.cnf pelat, √©s a dir totes les variables que hem configurat de tipus: `innodb_file_per_table`, `default-storage-engine=InnoDB` les hem de comentar perqu√® sin√≥ ens donar√† error al reiniciar el servei, sempre al primer cop quan ha de crear l'estructura de fitxers al reiniciar el servei nom√©s hem de tenir sense comentar les variables `datadir`,`datadir`,`log-error`,`pid-file`. Despr√©s de que es reinici el servei i es crei l'estructura de fitxers, ja podem descomentar les linies anteriors que teniem. Per√≤ compte perqu√® tota la configuraci√≥ ja sigui Storage Engine o un altre configuraci√≥ instal¬∑lat externament haurem de tornar-les a instal¬∑lar si les volem tenir, perqu√® al generar-se nous fitxers de configuraci√≥ aquestes externes es perden.

Llavors obrirem el fitxer de configuraci√≥ de MySQL
```
# nano /etc/my.cnf
```
I borrarem / comentarem totes les lineas de configuraci√≥ de variables que tenen a veure amb caracter√≠stiques instal¬∑lades externs, en aquest cas de MyRocks, perqu√® al generar-se un nou directori de dades sense fer c√≤pia de l'anterior, totes les instal¬∑lacions externes es perden i no t√© sentit intentar configurar una variable d'una caracter√≠stica (Storage Engine en aquest cas per√≤ podria ser un altre) que no en tenim instal¬∑lada.

Tamb√© comentarem les lineas de configuraci√≥ (si en tenim), d'altres par√†metres de MySQL, com per exemple el `default-storage-engine`, `innodb_file_per_table` perqu√® en el primer reinici que farem m√©s endavant hem de tenir nom√©s especificat `datadir`, `socket`, `pid-file (el deixarem per defecte)` i `log-error (el deixarem per defecte)`
```
[mysqld]
datadir=/hd-mysql
socket=/hd-mysql/mysql.sock
```
<details open>
<summary><b>Comentar les lineas sobrants i canviar el directori de dades i socket</b></summary>
<img src="captures/mycnf-datadir.png">
</details>

Guardem el fitxer de configuraci√≥ i sortim.

Ara, si estem utilitzant RHEL / CentOS , si no tenim el `SELINUX` desactivat hem de afegir el `SELinux Security Context` a la nova ubicaci√≥, per a que funcioni. Tamb√© el podrem deshabilitar per evitar problemes
```
# semanage fcontext -a -t mysqld_db_t "/hd-mysql(/.*)?"
# restorecon -R /hd-mysql
```
<details open>
<summary><b>Afegir el SELinux Security Context a la nova ubicaci√≥</b></summary>
<img src="captures/selinux.png">
</details>

Un cop fet aix√≤, si reiniciem el servei de MySQL i mirem l'estatus no hi hauriem de tenir cap problema.
```
# systemctl restart mysqld && systemctl status mysqld
```
<details open>
<summary><b>Reiniciar i veure l'estat del Servei</b></summary>
<img src="captures/restart_status.png">
</details>

I si mirem en el nou directori, podrem veure com ha reprodu√Øt tota la estructura.

‚ö†Ô∏è ATENCI√ì ‚ö†Ô∏è : SI FEM AQUEST PAS DE REINICIAR, DESPR√âS HEM DE TORNAR A BORRAR TOT I CREAT TOT DE NOU PERQU√à EN L'APARTAT DE IBDATA CANVIAREM EL DIRECTORI I NO MANTINDREM EL IBDATA1 QUE ENS CREAR√Ä ARA A `/HD-MYSQL`. LLAVORS TORNAREM A GENERAR LA ESTRUCTURA PER√í LOCALITZANT ELS IBDATA EN UN LLOC DIFERENT. LLAVORS SI NO CANVIAR√ÄS ELS PATH DEL IBDATA POTS FER AQUEST PAS TRANQUILAMENT.

<details open>
<summary><b>Comprovar que ha creat els fitxers (tota la estructura)</b></summary>
<img src="captures/lshd-mysql.png">
</details>

Ara, tornarem al `my.cnf`, i descomentarem les linies comentades anteriorment, on modificavem algunes variables del MySQL, excepte les variables que fan refer√®ncia a una caracter√≠stica instal¬∑lada, que ara al ser nova estructura no el tenim i per tant l'hem d'instal¬∑lar de nou si el volem fer servir.

Llavors descomentarem les linies (si en teniem abans o volem tenir) i tamb√© afegirem una configuraci√≥ extra, per a que ens funcioni el login per MySQL i no ens doni error de `Socket` m√©s endavant, perqu√® aquestruta del Socket si no l'especifiques en la secci√≥ de `[Client]` utilitza la que t√© per defecte, i com hem canviat de directori hem d'especificar el del nou directori.
```
# nano /etc/my.cnf
```
```
[client]
socket=/hd-mysql/mysql.sock
```
<details open>
<summary><b>Descomentar les linies de variables que utilitzem, i configurar per a que funcioni el socket per part del client</b></summary>
<img src="captures/mycnf2.png">
</details>

Guardarem i reiniciarem el Servei.
```
# systemctl restart mysqld && systemctl status mysqld
```
<details open>
<summary><b>Reiniciar i veure l'estat del Servei</b></summary>
<img src="captures/restart_status2.png">
</details>

Ara, hem d'anar a l'arxiu de logs i buscar la contrasenya que ens haur√† generat del Root
```
# cat /var/log/mysql.log | grep "Generated"
```
<details open>
<summary><b>Obtenir la contrasenya del Root</b></summary>
<img src="captures/password_generated.png">
</details>

Ara, iniciarem sessi√≥ amb root i canviarem la contrasenya.
```
# mysql -u root -p"pwd_generat"
```
```
mysql> ALTER USER 'root'@'localhost' IDENTIFIED BY 'N3wP4ssw0rd'; flush privileges;
```
<details open>
<summary><b>Iniciar sessi√≥ i canviar contrasenya</b></summary>
<img src="captures/change_pwd.png">
</details>

Si volem, tamb√© podem comprovar que s'ha canviat mirant les variables pel MySQL.
```
mysql> SHOW VARIABLES WHERE Value LIKE '%/hd%';
```
<details open>
<summary><b>Comprovar nova ruta de les variables</b></summary>
<img src="captures/valuelikehd.png">
</details>

Ara, per √∫ltim lloc, si ens volem assegurar que el nostre MySQL ja no dep√©n dels fitxers de l'antiga ruta podem renombrar l'antiga ruta i reiniciar el MySQL, si no dona error √©s que ho tenim b√© i hem canviat la localitzaci√≥ correctament.

Despr√©s tornarem a posar el nom antic per si volem tornar a la ruta.
<details open>
<summary><b>Comprovar que el nostre MySQL ja no dep√©n de l'antiga ruta</b></summary>
<img src="captures/comprobacion.png">
</details>

### Configuraci√≥ System Tablespace en 2 Discos
En aquest apartat, configurarem 2 System TablesSpace. Els dos amb mida 50MB inicial, fent-los creixent de 5 MB en 5 MB i el `ibdata1` est√†ra en `/disk1/` i el `ibdata2` estar√† en `/disk2/`.

Llavors comen√ßem insertant els discos virtuals en la nostra m√†quina virtual / real si estem fent-ho en un cas real.

Els discos en aquest cas de prova s√≥n de 2GB cadasc√∫n.
<details open>
<summary><b>Disk 1 creat i insertat</b></summary>
<img src="captures/new_hard_disk1.png">
</details>
<details open>
<summary><b>Disk 2 creat i insertat</b></summary>
<img src="captures/new_hard_disk2.png">
</details>

Ara iniciarem la m√†quina.
Comprovarem que tenim m√©s discos insertats amb la comanda lsblk
```
# lsblk
```
<details open>
<summary><b>Veure que el sistema reconeix els 2 discos</b></summary>
<img src="captures/lsblk.png">
</details>

Ara accedirem al menu del programa `fdisk` indicant el disk1, √©s a dir que els canvis realitzats dins d'aquest men√∫ es realitzar√†n sobre el disk1

```
# sudo fdisk /dev/sdb
``` 
Despr√©s premem la lletra `M` i `Intro` per veure les opcions que tenim amb el disk
<details open>
<summary><b>Accedir al menu fdisk indicant el disc /dev/sdb (Disk1)</b></summary>
<img src="captures/menufdisk.png">
</details>

Ara, crearem una partici√≥ primaria.
<details open>
<summary><b>Crear partici√≥ prim√†ria</b></summary>
<img src="captures/partitionprimary.png">
</details>

Mirarem com ha quedat la partici√≠ i despr√©s, guardarem els canvis realitzats i sortirem del menu.
<details open>
<summary><b>Veurem els canvis com han quedat, els guardarem i sortirem.</b></summary>
<img src="captures/writechanges.png">
</details>

Ara, hem de formatar la partici√≥ en el sistema de fitxers de linux `ext4`. Com abans hem consultat la partici√≥ sabem com es diu, en aquest cas `dev/sdb1`
```
# sudo mkfs -t ex4 /dev/sdb1
```
<details open>
<summary><b>Formatar la partici√≥ a ext4</b></summary>
<img src="captures/mkfsdevsdb1.png">
</details>

I ara si consultem la partici√≥ podem veure que ja est√† preparat per ser montat
```
# lsblk -o NAME,FSTYPE,SIZE /dev/sdb1
```
<details open>
<summary><b>Veure com ha quedat la partici√≥ del primer disc</b></summary>
<img src="captures/lsblkparam.png">
</details>

Informaci√≥ de creaci√≥ de particions extreta [d'aquesta p√†gina](https://www.sapalomera.cat/moodlecf/apunts/smx/sox/index.html?cap=100&ref=2232).

**LLAVORS FARIEM LO MATEIX PER√í PER L'ALTRE DISC (DISC2)**

I aix√≠ es veuria el segon disc al fer els passos anteriors.
<details open>
<summary><b>Veure com ha quedat la partici√≥ del segon disc</b></summary>
<img src="captures/lsblkparam2.png">
</details>

Arribat en aquest punt tenim preparat lo seg√ºent:

- Disc 1 Partici√≥ 1 --> `/dev/sdb1` fs=ext4
- Disc 2 Partici√≥ 1 --> `/dev/sdc1` fs=ext4

Ara, crearem els directoris de /disk1 i /disk2 a l'arrel que √©s on muntarem els discs amb els permisos adients per el MySQL. Encara que despr√©s de montar el disc sobre la carpeta pot ser que els permisos configurats ara desapareixin i es posin els de root
```
# mkdir /disk1
# chown -R mysql:mysql /disk1
# chmod 751 /disk1

# mkdir /disk2
# chown -R mysql:mysql /disk2
# chmod 751 /disk2
```
<details open>
<summary><b>Creaci√≥ de carpetes i permisos on muntarem els discs</b></summary>
<img src="captures/mkdir_disk1_disk2.png">
</details>

Ara, muntarem les particions temporalment en el seu directori corresponent per veure si hi ha alg√∫n problema i veure com ho monta.
```
# sudo mount -t ext4 /dev/sdb1 /disk1
# sudo mount -t ext4 /dev/sdc1 /disk2
# df -lh
```
<details open>
<summary><b>Muntar les particions manualment i veure si hi ha algun problema</b></summary>
<img src="captures/temporal_mount.png">
</details>


Un cop sabem que pot muntar-ho sense problema, en comptes de muntar-ho manualment afegirem unes linies en `etc/fstab` per a que cada vegada que s'inicii el sistema operatiu ell ho monti autom√†ticament i no tinguem cap problema.

```
# nano /etc/fstab
```

I afegirem les seg√ºents lineas per a que ho monti.
```
# Muntar /dev/sdb1 en /disk1
/dev/sdb1   /disk1     ext4    defaults        0       3

# Muntar /dev/sdc1 en /disk2
/dev/sdc1   /disk2     ext4    defaults        0       3
```
<details open>
<summary><b>Montar les particions en els directoris des d'el Fstab de manera que al iniciar el sistema es montin autom√†ticament</b></summary>
<img src="captures/fstab.png">
</details>

Ara guardarem i reiniciarem la m√†quina.
<details open>
<summary><b>Reiniciar la m√†quina</b></summary>
<img src="captures/init6.png">
</details>

Un cop que s'inicii amb la comanda `mount` mirarem si ens ha montat el disc i despr√©s amb la comanda df -lh ho tornarem a verificar, aix√≠ estarem segurs al 100%.
```
# mount | grep "disk"
# df -lh
```
<details open>
<summary><b>Comprobaci√≥ de que s'ha montat autom√†ticament correctament</b></summary>
<img src="captures/mount_dflh.png">
</details>

Ara, al montar el disc sobre la carpeta, pot ser que es canviin els permisos a root autom√†ticament.
Si passa aix√≤ tornem a posar els permisos, propietari i grup d'aquestes carpetes.
```
# chown -R mysql:mysql /disk1
# chmod 751 /disk1

# chown -R mysql:mysql /disk2
# chmod 751 /disk2
```
<details open>
<summary><b>Permisos Discs</b></summary>
<img src="captures/permisos_disk.png">
</details>

Arribat en aquest punt ja tenim preparat els discs, el directori amb els permisos adients.

‚ö†Ô∏èATENCI√ì‚ö†Ô∏è: EN AQUEST PAS CANVIAREM LA RUTA DELS IBDATA SENSE MANTENIR L'ANTERIOR QUE ENS HA GENERAT, AIX√í VOL DIR RE GENERAREM LA ESTRUCTURA DEL `/hd-mysql` LOCALITZANT EN UN LLOC DIFERENTS ELS IBDATA I PERDREM LES DADES ANTERIORS, SI VOLEM QUE LES DADES ANTIGUES ES MANTINGUIN HAUREM D'ESPECIFICAR 3 IBDATA, L'ANTIC, EL NOU I EL SEGON NOU PER√í EN AQUEST CAS FAREM LA VERSI√ì DE RE GENERAR-LOS.

Ara el que farem ser√† canviar la ruta dels `ibdata` cap a discos externs.

Primer, desactivarem el `SE LINUX` si estem utilitzant un SO `RHEL` o `CENTOS`, podriem afegir la regla a la nova ubicaci√≥, per√≤ per evitar m√©s problemes el desactivem.
```
# nano /etc/selinux/config
SELINUX=disabled
```
<details open>
<summary><b>Desactivar SELINUX</b></summary>
<img src="captures/disable_selinux.png">
</details>

Posteriorment, guardarem els canvis i reiniciarem la m√†quina.

```
# init 6
```

Com s'ha dit anteriorment, com regenerarem el contingut i perdrem les dades, hem de buidar el contingut de `/hd-mysql` o la ruta del dest√≠ que tinguem per a que torni a generar tots els fitxers, si canviem de dest√≠ no fa falta aquest pas.

```
# rm -r -R -f /hd-mysql/*
```

<details open>
<summary><b>Borrar el contingut de la carpeta dest√≠ per generar els fitxers</b></summary>
<img src="captures/vaciar_destino.png">
</details>


Anirem a l'arxiu de configuraci√≥ de MySQL situat a `/etc/my.cnf`.
```
# nano /etc/my.cnf
```
I afegirem les seg√ºents linies en la secci√≥ de `[mysqld]`.

La seg√ºent linia treiem el path del data_home_dir, perqu√® despr√©s en el ibdata especificarem la ruta absoluta on guardarem els ibdata. Sin√≥ concatenara la ruta d'aquest par√†metres m√©s la ruta que es posi en el ibdata.
- `innodb_data_home_dir =`  

La seg√ºent linia especificarem la ruta absoluta de cada ibdata, amb la mida inicial de 50M, i el segon ibdata creixer√† autom√†ticament a mesura que ho necessiti. Si en el par√†metre anterior especifiquem alguna ruta, utilitzar√† la ruta anterior + la que es posi en aquest par√†metre
`
- `innodb_data_file_path=/disk1/ibdata1:50M;/disk2/ibdata2:50M:autoextend`

La seg√ºent linia indicar√† de quina mida anir√† creixent el ibdata que tingui autoextend.
- `innodb_autoextend_increment = 5`

```
[mysqld]
datadir=/hd-mysql
socket=/hd-mysql/mysql.sock

log-error=/var/log/mysqld.log
pid-file=/var/run/mysqld/mysqld.pid

innodb_file_per_table=OFF

innodb_data_home_dir = 
innodb_data_file_path=/disk1/ibdata1:50M;/disk2/ibdata2:50M:autoextend
innodb_autoextend_increment=5

mysqlx_socket = /hd-mysql/mysqlx.sock

[client]
socket=/hd-mysql/mysql.sock
```

Tamb√© si mirem en els apartats anterior s'explica que en el fitxer de configuracio `my.cnf` en la secci√≥ de `[mysqld]` haviem de comentar els par√†metres opcionals que teniem posats per a que la primera vegada que regenerra l'estructura no doni error, per exemple el par√†metre de `default-storage-engine` s'ha de comentar (despr√©s de que monti la estructura podem descomentar aquestes linees). Tamb√© posarem la secci√≥ de `[client]` especificant la nova ruta del `Socket` per a que ens deixi loguejar-nos.
Tamb√© podem especificar el socket del `Plugin X` de MySQL, que es diu `mysqlx.sock`.

<details open>
<summary><b>Configuraci√≥ per regenerar la estructura i tenir 2 System Tablespace en llocs diferents</b></summary>
<img src="captures/innodb_data.png">
</details>

Ara, reinicirem el servei de MySQL i si tot va b√© haur√† reiniciat amb √®xit. Si no funciona amb √©xit, borra els fitxers que ha generat al directori de dades, i tornarem a provar de reiniciar.

```
# systemctl restart mysqld
# systemctl status mysqld
```
<details open>
<summary><b>Reiniciar servei MySQL</b></summary>
<img src="captures/systemctl_status.png">
</details>

Si mirem el directori de dades podrem veure que ha generat tot.
```
# ls -alis /hd-mysql
```
<details open>
<summary><b>Directori de dades generat</b></summary>
<img src="captures/ls_alis_hdmysql.png">
</details>

I si mirem els discos en cada disc ha creat el seu ibdata amb `50MB` inicials.
```
# ls -alish /disk1
# ls -alish /disk2
```
<details open>
<summary><b>Veure els ibdata generat i la seva mida</b></summary>
<img src="captures/ls_alish_disk.png">
</details>

Ara, com s'ha fet en l'apartat de canviar el directori de MySQL, hem de tornar a buscar la contrasenya del Root en els logs, i tornar-la a canviar.
```
# cat /var/log/mysqld.log | grep "generated"
```
```
# mysql -u root -p"passwordgenerated"
```
```
mysql> ALTER USER 'root'@'localhost' IDENTIFIED BY 'N3WP4SSW0RD';
mysql> FLUSH PRIVILEGES;
```
<details open>
<summary><b>Canviar contrasenya del Root</b></summary>
<img src="captures/recover_password.png">
</details>

I ara tamb√© podem mirar per les variables del MySQL les rutes dels par√†metres que hem canviat.
```
mysql> SHOW VARIABLES WHERE VALUE LIKE '%/hd-mysql%';
mysql> SHOW VARIABLES WHERE VALUE LIKE '%/dis%';
mysql> SHOW VARIABLES LIKE '%autoextend%';
mysql> SHOW VARIABLES LIKE '%innodb_data_h%';
```
<details open>
<summary><b>Veure que han canviat els path dels variables com a comprovaci√≥</b></summary>
<img src="captures/show_variables_change.png">
</details>

Ara, tornarem a importar la BD de Sakila el Schema com a taules InnoDB, (ens assegurarem que tenim per defecte el Storage Engine InnoDB). 
```
mysql> SOURCE /root/sakila-db/sakila-schema.sql;
mysql> SOURCE /root/sakila-db/sakila-data.sql;
```
<details open>
<summary><b>Importar BD Sakila (Schema)</b></summary>
<img src="captures/import_sakila_schema.png">
</details>
<details open>
<summary><b>Importar BD Sakila (Data)</b></summary>
<img src="captures/import_sakila_data.png">
</details>
<hr>

## Tablespace per cada taula en una ruta especificada.
Partint del punt anterior, modificarem la configuraci√≥ del MySQL, per a que cada taula generi el seu propi tablespace dins d'una carpeta que crearem preparada per aquests tablespaces.

Llavors comen√ßarem creant la carpeta que es dir√† `tspaces` i estar√† situada a `/tspaces`, la ruta d'aquest arxiu ser√† `/tspaces`, hem de crear la carpeta de tspaces en un lloc diferent del directori de dades, perqu√® per raons de seguretat no ens deixar√† posar el data directory de la taula a una ruta descendent del directori de dades.

Crearem la carpeta i li posarem els permisos adients de MySQL
```
# mkdir /tspaces
# chown mysql:mysql -R /tspaces
# chmod 751 -R /tspaces
```
<details open>
<summary><b>Crear i preparar el directori dels tablespaces</b></summary>
<img src="captures/mkdir_tspaces.png">
</details>

üü¢ MANERA 1üü¢

Anirem al `my.cnf` i posarem en ON o treiem la variable de `innodb_file_per_table` d'aquesta manera cada taula generar√† el seu propi tablespace, per defecte si no hi ha aquest par√†metre especificat en el `my.cnf`, genera el seu propi tablespace. Tamb√© posarem el par√†metre `innodb_directories` especificant el directori de confian√ßa `/tspaces`, perqu√® si tenim un directori apart creat per nosaltres i no √©s natiu del MySQL, tindrem problemes, l'haurem de dir en el par√†metre que aquest directori forma part dels directoris d'InnoDB
```
# nano /etc/my.cnf

[mysqld]
innodb_file_per_table=ON
innodb_directories="/tspaces";
```
<details open>
<summary><b>Activar el par√†metre innodb_file_per_table i especificarem innodb_directories</b></summary>
<img src="captures/innodb_file_per_table_directories.png">
</details>

Posteriorment reiniciarem i comprovarem el servei de MySQLD
```
# systemctl restart mysqld && systemctl status mysqld
```
<details open>
<summary><b>Reiniciar i comprovar el servei de MySQL</b></summary>
<img src="captures/systemctl_status2.png">
</details>

Si volem que per defecte els tablespaces de les taules es generin en un data directori diferent a la del `datadir`, no podem fer-ho, no hi ha cap opci√≥. El que si que podem fer √©s alhora de crear la taula especificar en la mateixa sent√®ncia el data directori d'aquella taula i d'aquesta manera canviar-li la ruta del tablespace que generar√† aquesta taula. Perqu√® per el tablespace de les taules les genera en el directori `datadir` del `MySQL` dins d'una carpeta de la seva BD.

Llavors el que farem, ser√† en la sent√®ncia DDL especificaR amb el par√†metre `DATA DIRECTORY` la ruta on volem que generi el tablespace de la taula

Llavors ara, entrarem al MySQL i crearem nostra BD de prova amb la taula especificant el directori del tablespace creat anteriorment.
```
mysql>CREATE DATABASE provaSpace;
mysql>USE provaSpace;
mysql>CREATE TABLE taulaProves (id INT PRIMARY KEY, nom VARCHAR(30)) DATA DIRECTORY="/tspaces/";
```
<details open>
<summary><b>Crear taula especificant el directori del tablespace</b></summary>
<img src="captures/data_directory_tspaces.png">
</details>

üü¢ MANERA 2 üü¢

Tamb√© tenim una manera alternativa de crear el tablespace d'una taula en un directori espec√≠cic. Aquesta manera alternativa, √©s per si no volem especificar els par√†metres `innodb_file_per_table` i `innodb_directories` en el `my.cnf` i ho volem especificar nom√©s en la sent√®ncia DDL de la creaci√≥ de taula, fent d'aquesta manera una "creaci√≥ excepcional de taula"

√âs a dir en la sent√®ncia DDL posant uns par√†metres podem fer una creaci√≥ excepcional i dir que aquesta taula tindr√† el innodb_file_per_table i el seu directori de dades estar√† situada a X lloc, sense la necessitat de modificar par√†metres a nivell de fitxer.
```
mysql>CREATE DATABASE provaSpace;
mysql>USE provaSpace;
mysql>CREATE TABLE taulaProves (id INT PRIMARY KEY, nom VARCHAR(30)) TABLESPACE=innodb_file_per_table DATA DIRECTORY="/tspaces/";
```
En la comanda anterior, especificarem que el `tablespace` sigui `innodb_file_per_table`, segons les fonts de MySQL amb aquest par√†metre t'estalvies activar el par√†metre per el `my.cnf`, i el par√†metre `DATA DIRECTORY` tindr√† com a valor la ruta on volem guardar el tablespace..

I d'aquesta manera creariem el tablespace de la taula en una ruta diferent sense tocar par√†metres a nivell de fitxer

<details open>
<summary><b>Creaci√≥ de la taula especificant el directori del tablespace</b></summary>
<img src="captures/tablespace-datadirectory.png">
</details>

‚ö†Ô∏èAtenci√≥: Si es posa el par√†metre `DATA DIRECTORY` sense que acompanyi el par√†metre `TABLESPACE` (encara que estigui ON a nivell de fitxer), posiblement doni un error, la soluci√≥ del error en molts casos √©s posant el par√†metre `TABLESPACE`, o si ho volem fer de la manera 1, especificar el `innodb_directories`

<details open>
<summary><b>Posible error i soluci√≥</b></summary>
<img src="captures/tablespace-datadirectoryerror.png">
</details>

üü¢ COMPROVACIONS üü¢

I si mirem la ruta del DATA DIRECTORY que hem especificat abans podem trobat el tablespace de la taula. Cada taula estar√† dins d'una carpeta que es dir√† amb el nom de la BD que pertany la taula, funcionar√† qualsevol de les dues maneres
```
# ls -alish /tspaces/provaSpace/
```
<details open>
<summary><b>Verificar que guarda el tablespace en la carpeta tspaces</b></summary>
<img src="captures/ls-tspaces-provaSpace.png">
</details>

I mirarem tamb√© com ha quedat la carpeta de la BD de la taula en el directori de dades que en teoria ha de quedar buida perqu√® la √∫nica taula que t√© l'hem creat en una ruta diferent.
```
# ls -alish /hd-mysql/provaSpace
```
<details open>
<summary><b>Verificar que la carpeta de la BD del directori de dades anterior ha quedat buida</b></summary>
<img src="captures/ls-provaSpace-vacio.png">
</details>
<hr>

## Creaci√≥ Tablespace Generals
En aquest apartat crearem tablespaces generals en discos diferents i dividirem les taules de la BD de Sakila en aquests dos tablespaces situats en llocs diferents.

### Tablespace ts1 a /disk1 i ts2 a /disk2
Crearem un tablespace anomenat ts1 a `/disk1` on situarem les taules de "actor", "address", i "category" de la BD de Sakila.

Ara, la opci√≥ innodb_file_per_table ens es igual.

El que farem ser√† d'un principi anar a l'arxiu de configuraci√≥ `my.cnf` i afegir "directoris de confian√ßa del innodb" apuntant cap al dest√≠ per evitar un error al crear el tablespace fora del directori de dades.
```
# nano /etc/my.cnf
```
```
[mysqld]
innodb_directories=/disk1;/disk2
```
<details open>
<summary><b>Afegit "paths" de confian√ßa en el innodb per poder guardar dades fora de la ruta del directori de dades</b></summary>
<img src="captures/innodb_directories.png">
</details>

Amb lo anterior ens estalviem el seg√ºent error alhora de crear el tablespace en un path diferent a la del directori de dades:
<details open>
<summary><b>Error que tindriem al crear el tablespace fora del directori de dades si no posem el par√†metre anterior.</b></summary>
<img src="captures/error_confianca.png">
</details>

Reiniciarem el servei i el comprovarem.
```
# systemctl restart mysqld && systemctl status mysqld
```
<details open>
<summary><b>Reiniciar el servei per aplicar els canvis anteriors</b></summary>
<img src="captures/systemctl_status3.png">
</details>

Si volem comprovar que la variable s'ha modificat ho podem veure mitjan√ßant una consulta SQL.
```
mysql> SHOW VARIABLES LIKE '%directori%';
```
<details open>
<summary><b>Comprovar que la variable innodb_directories s'ha modificat correctament</b></summary>
<img src="captures/like_directori.png">
</details>

Posteriorment crearem els tablespaces `ts1` situat a `/disk1` i el `ts2` situat a `/disk2` mitjan√ßant sent√®ncies SQL. (Tenim els permisos de carpeta de disk1 i disk2 configurats en els apartats anteriors)
```
mysql> CREATE TABLESPACE ts1 ADD DATAFILE '/disk1/ts1.ibd' ENGINE=InnoDB;
```
```
mysql> CREATE TABLESPACE ts2 ADD DATAFILE '/disk2/ts2.ibd' ENGINE=InnoDB;
```
<details open>
<summary><b>Creaci√≥ dels tablespaces</b></summary>
<img src="captures/create_tablespace.png">
</details>

Podem llistar els directoris i podem mirar que s'han creat correctament.
```
# ls -alish /disk1
# ls -alish /disk2
```
<details open>
<summary><b>Veure que ha creat els tablespaces en els directoris</b></summary>
<img src="captures/ls_ts.png">
</details>

### Importar Sakila col¬∑locant les taules en els tablespaces
Ara, importarem la BD de Sakila per√≤ les taules repartides en els tablespaces que hem creat anteriorment.

Si ja tenim la BD Sakila, haurem de modificar el tablespace mitjan√ßant la sent√®ncia ALTER. Modificarem la taula i li assignarem el tablespace, pero a continuaci√≥ farem la versi√≥ d'importaci√≥.

El que hem de fer ara √©s modificar les sent√®ncies DDL de les creacions de les taules `actor`,`address`, i `category` i assignar aquests en el tablespace `ts1`.

Llavors obrirem el Schema DB de Sakila per editar el contingut
```
# nano /root/sakila-db/sakila-schema.sql
```
I a les taules actor, address i category, afegirem el tablespace `ts1` creat anteriorment, de manera que es veurien aix√≠ finalment les taules amb el par√†metre `TABLESPACE`, encara que estigui posat, important que les taules estiguin en InnoDB!:
```
TABLESPACE ts1
```
<details open>
<summary><b>Canviar el DDL de les taules actor address i category i afegir-los al tablespace ts1 (abans d'importar-lo a la BD)</b></summary>
<img src="captures/tablespace_ts1.png">
</details>

I a la resta de taules els afegirem al tablespace ts2
```
TABLESPACE ts2
```
<details open>
<summary><b>Canviar el DDL de la resta de taules i afegir-los al tablespace ts2 (abans d'importar-lo a la BD)</b></summary>
<img src="captures/tablespace_ts2.png">
<img src="captures/tablespace_ts2_1.png">
<img src="captures/tablespace_ts2_2.png">
<img src="captures/tablespace_ts2_3.png">
<img src="captures/tablespace_ts2_4.png">
<img src="captures/tablespace_ts2_5.png">
</details>

Guardarem els canvis de DDL fets al fitxer SQL del Schema de Sakila, i procedirem a importar, recordar que en cas de tenir-lo importat i voler canviar el tablespace ES POT !!!
[+ Informaci√≥](https://dev.mysql.com/doc/refman/5.7/en/general-tablespaces.html)

```
mysql> SOURCE /root/sakila-db/sakila-schema.sql
```
<details open>
<summary><b>Importat l'Schema de Sakila amb les modificacions en les taules DDL que hem fet</b></summary>
<img src="captures/import_sakila_to_ts.png">
</details>

Un cop importat, per comprovar que les taules anteriors pertanyen cadasc√∫ al seu general tablespace corresponent ho podrem verificar amb les seg√ºents sent√®ncies, on LIKE 'ts1' equival al nom del nostre tablespace
```
mysql> SELECT a.NAME AS space_name, b.NAME AS table_name
FROM INFORMATION_SCHEMA.INNODB_TABLESPACES a,
INFORMATION_SCHEMA.INNODB_TABLES b 
WHERE a.SPACE=b.SPACE AND a.NAME LIKE 'ts1';
```
<details open>
<summary><b>Verificar les taules pertanyents al tablespace ts1</b></summary>
<img src="captures/check_ts1.png">
</details>

Ara verificarem les taules del ts2.
```
mysql> SELECT a.NAME AS space_name, b.NAME AS table_name
FROM INFORMATION_SCHEMA.INNODB_TABLESPACES a,
INFORMATION_SCHEMA.INNODB_TABLES b 
WHERE a.SPACE=b.SPACE AND a.NAME LIKE 'ts2';
```
<details open>
<summary><b>Verificar les taules pertanyents al tablespace ts2</b></summary>
<img src="captures/check_ts2.png">
</details>

A m√©s podrem verificar la mida dels generals tablespaces `ts1` i `ts2`, si ho comparem amb la anterior mida que es pot veure en els apartats anteriors d'aquest document, aquesta mida ha pujat degut a les importacions que hem fet.
(√íbviament la mida del ts2 √©s major ja que cont√© m√©s taules amb m√©s camps)
```
# ls -lh /disk1/ts1.ibd
# ls -lh /disk2/ts2.ibd
```
<details open>
<summary><b>Verificar que la mida dels tablespaces ha pujat</b></summary>
<img src="captures/check_ts_size.png">
</details>

Tamb√© podem mirar el directori de dades de la BD, hauria d'estar buit.
<details open>
<summary><b>Verificar que les taules no es guarden al directori per defecte, sin√≥ que estan en els tablespaces</b></summary>
<img src="captures/vacio_sakila.png">
</details>

Un cop verificat que tenim ben configurats els tablespaces, procedirem a importar el contingut de les taules.
```
mysql> SOURCE /root/sakila-db/sakila-data.sql
```
<details open>
<summary><b>Importar el contingut de les taules Sakila</b></summary>
<img src="captures/sakila_data.png">
</details>

Ara, tornarem a verificar la mida dels tablespaces i podem veure que encara han crescut m√©s.
```
# ls -lh /disk1/ts1.ibd
# ls -lh /disk2/ts2.ibd
```
<details open>
<summary><b>Verificar que la mida dels tablespaces ha tornat a pujar</b></summary>
<img src="captures/check_ts_size2.png">
</details>

Ara, finalment ens queda comprovar que podem fer sent√®ncies DML sobre aquestes dades guardades en diferents tablespaces.

Farem un parell de sent√®ncies "chorras", un a cada taula situat a cada tablespace.
```
mysql> UPDATE actor SET first_name = "bb" WHERE first_name RLIKE '.mp.';
```
<details open>
<summary><b>Canvis DML a la taula situada a ts1</b></summary>
<img src="captures/dml_ts1.png">
</details>

I comprovarem que s'han realitat els canvis
```
mysql> SELECT * FROM actor;
```
<details open>
<summary><b>Comprovaci√≥ dels canvis realitzats de la taula actor</b></summary>
<img src="captures/dml_ts1_prueba.png">
</details>

Ara modificarem una taula que estigui en el ts2 com per exemple la taula `country`
```
mysql> UPDATE country SET last_update = now();
```
<details open>
<summary><b>Canvis DML a la taula situada a ts2</b></summary>
<img src="captures/dml_ts2_prueba.png">
</details>

<details open>
<summary><b>Comprovaci√≥ dels canvis realitzats de la taula country</b></summary>
<img src="captures/dml_ts1_select.png">
</details>

Arribat en aquest punt ja sabem que tenim els tablespaces correctament configurats. 