# STORAGE ENGINE MyRocks <img align="right" width="230" src="../imatges/myrocks_logo.png"/>

## Connexi贸 per SSH al Sistema
Primer de tot, ens connectarem a la mquina per **SSH** desde CMD (ho tenim pr猫viament instal路lat).
```
ssh machineuser@ip 
```
<details open>
<summary><b>Connexi贸 per SSH</b></summary>
<img src="captures/ssh.png">
</details>

<hr>

## s del Storage Engine MyRocks
### Introducci贸 a MyRocks
MyRocks 茅s un motor d'emmagatzematge basat en RocksDB. s de tipus Clau-Valor.

L'utilitza Facebook i han fet un estudi de rendiment amb InnoDB i han trobat diferents ventatges.

Les Advantatges a sobre del InnoDB s贸n:

- <b><span style="color:green">Efici猫ncia de Compressi贸:</span></b> Comprimeix millor perqu猫 no utilitza mides de paginaci贸 fixes. Si en MyRocks una pgina es comprimeix en 5 KB nom茅s utilitzar aquest 5 KB d'emmagatzematge. Estalvia espai en disc i indirectament estalvia diners.

- <b><span style="color:green">Annexaci贸 i Compactaci贸:</span></b> Utilitza menys quantitat de lectures i escriptures perqu猫 els patrons d'acc茅s a les dades estan emmagatzemats de manera persistents i s贸n de clau-valor.

- <b><span style="color:green">Replicaci贸 m茅s rpida:</span></b> MyRocks no necessita lectures aleatories per actualitzar les claus primries i no necessita verificar la integritat (replicaci贸 sense lectura)

- <b><span style="color:green">Carrega de dades m茅s rpid:</span></b> Activat aquesta opci贸 a nivell de sessi贸 MyRocks escriu dades directament en el nivell m茅s baix, i evita tots els gastos de compactaci贸 que aquests utilitzen CPU, E/S per comprimir i descomprimir dades.

    [M茅s informaci贸](https://www.codetd.com/es/article/12032793)

    [M茅s informaci贸+](https://engineering.fb.com/2016/08/31/core-data/myrocks-a-space-and-write-optimized-mysql-database/)

    [M茅s informaci贸++](https://rimzy.net/category/myrocks/)

### Casos d's

RocksDB s'utilitza mpliament per emmagatzemar dades persistents en SSD a Facebook, i tamb茅 l'utilitzen diversos serveis que serveixen consultes en l铆nia als discs durs.

Com que MyRocks 茅s un motor d'emmagatzematge basat en arbres LSM constru茂t sobre RocksDB. T茅 moltes ventatges sobre els B+Tree tradicionals com els que t茅 el InnoDB, utilitzant menys espai en el disc i una escriptura redu茂da aix貌 a nivell comercial produeix:
> - Disminuci贸 del cost d'emmagatzematge al n煤vol/HDFS per a c貌pies de seguretat
>- L'amplificaci贸 d'escriptura redu茂da d贸na com a resultat una vida 煤til m茅s llarga del disc
>- L'espai redu茂t requereix menys divisions i augmenta la pista.

### Creaci贸 de BD amb Taules de Storage Engine MyRocks
Ara, crearem una BD on posteriorment crearem Taules fent servir el Storage Engine MyRocks.

```
mysql> CREATE DATABASE myRocks;
USE myRocks;
```
<details open>
<summary><b>Crear BD per myRocks (on farem les proves)</b></summary>
<img src="captures/create_myRocks.png">
</details>

Ara crearem un seguit de taules utilitzant aquest Storage Engine, tamb茅 crearem un 铆ndex per les claus primries.
```
mysql> CREATE TABLE taula1(
    id INT, nom VARCHAR(30),
    PRIMARY KEY (id) COMMENT 'cfname=cf1')ENGINE=RocksDB;
```

```
mysql> CREATE TABLE taula2(
    id INT, nom VARCHAR(30), cognom VARCHAR(40),
    PRIMARY KEY (id) COMMENT 'cfname=cf1')
    ENGINE=RocksDB;
```

```
mysql> CREATE TABLE numbers(
a INT, b INT,
PRIMARY KEY (a) COMMENT 'cfname=cf1')
ENGINE = RocksDB;
```
<details open>
<summary><b>Creaci贸 de taules amb l'engine MyRocks</b></summary>
<img src="captures/createRocksTables.png">
</details>

Ara, inserirem dades en aquestes taules, amb 2 registres per cada taula en tenim prou
```
mysql> INSERT INTO taula1 VALUES (1,"Pere"),(2,"Marta");
```
```
mysql> INSERT INTO taula2 VALUES (1,"Carla","G贸mez"),(2,"Pere","Pi");
```
```
mysql> INSERT INTO numbers VALUES (10,20),(30,40),(50,60);
```
<details open>
<summary><b>Inserci贸 de dades a taules amb storage engine MyRocks</b></summary>
<img src="captures/inserts_myrocks.png">
</details>

### Directori Fitxers de Dades i Metadades
Un cop creada i feta les insercions en aquestes taules, tota aquesta informaci贸 (metadades i contingut de taules) es guarda en algun lloc en el nostre sistema gestor de base de dades d'una certa manera. Llavors anem a analitzar-los.

- El directori dels `fitxers de metadades` es a `/var/lib/mysql/nomBD/fitxerTaula`. En el meu cas per poder veure aquests fitxers es faria de la seg眉ent manera:
    ```
    mysql> ls /var/lib/mysql/myRocks/
    ```
    <details open>
    <summary><b>Llistar el directori de les metadades de les taules amb l'engine myRocks</b></summary>
    <img src="captures/llistar_metadades.png">
    </details>

- El directori dels `fitxers de dades` 茅s una carpeta oculta nomenada `.rocksdb` i aquesta carpeta oculta es troba a `/var/lib/mysql/`.

    Ho podrem saber tamb茅 buscant per la variable global %dir%, i fixant-nos en la variable `rocksdb_datadir`. Ens indicar segurament que per defecte 茅s `./.rocksdb`, aquest "." vol dir que dins d'aquell mateix directori que es troba ara mateix, hi ha una carpeta oculta, i quin 茅s aquell directori que es troba ara mateix? s `/var/lib/mysql` i a partir d'aix貌 dedu茂m que la ruta sencera dels fitxers de dades 茅s `/var/lib/mysql/.rocksdb`

    ```
    mysql> SHOW VARIABLES LIKE %dir%;
    ```
    <details open>
    <summary><b>Saber el directori dels fitxers de dades</b></summary>
    <img src="captures/rocksdb_dir.png">
    </details>

    Per llistar tots aquests fitxers i veure el que ocupen ho podem fer de la seg眉ent manera:

    `--block-size=K` --> Estem indicant que volem que la mida per tots els arxius ens ho mostri amb KiloBytes, perqu猫 si no posem mida, depenent de l'arxiu sempre ens ho mostra amb la unitat m茅s petita que pot per a cada arxiu, llavors per tenir tots en una 煤nica unitat l'especificarem.

    ```
    # ls -l --block-size=K /var/lib/mysql/.rocksdb/
    ```
    <details open>
    <summary><b>Veure el que ocupen els fitxers en KiloBytes</b></summary>
    <img src="captures/ls_blocksize.png">
    </details>

    I si volem que ens mostri per a cada arxiu amb la unitat m茅s petita que pot ho farem de la seg眉ent manera:

    ```
    # ls -lh /var/lib/mysql/.rocksdb/
    ```
    <details open>
    <summary><b>Veure el que ocupen els fitxers en la mida m茅s petita possible (ho decideix el Linux)</b></summary>
    <img src="captures/ls-lh.png">
    </details>

### Compressions RocksDB (MyRocks)
#### Format de Compressions per defecte
Tota la informaci贸 corresponent a dades de les taules les va guardant en fitxers .sst repartidament vists anteriorment, aquests fitxers si intentem obrir-los veurem que estan en binari, i aquest fitxers de binari a m茅s, estan comprimits per el format per defecte `LZ4`.

Per saber quin format de compressi贸 per defecte utilitza, ho podrem saber realitzant la seg眉ent consulta des del MySQL:
```
mysql> SELECT *
FROM information_schema.rocksdb_cf_options
WHERE option_type LIKE '%compression%'
AND cf_name='default';
```
<details open>
<summary><b>Format per defecte per compressi贸 (kLZ4 (LZ4))</b></summary>
<img src="captures/kLZ4_default.png">
</details>

A m茅s si mirem el contingut de qualsevol .sst, podrem veure que hi ha en algun lloc escrit les sigles LZ4 o el format que tingui.
```
# cat /var/lib/mysql/.rocksdb/000183.sst
```
<details open>
<summary><b>Forma alternativa de veure format de compressi贸 (LZ4)</b></summary>
<img src="captures/kLZ4_default2.png">
</details>

#### Canviar el format de compressi贸
RocksDB admet els seg眉ents formats de compressi贸:

> - Snappy
> - Zlib
> - LZ4 (per defecte)
> - LZ4HC
> - ZSTDNotFinal
> - Sense Compressi贸

#####  ZLIB 
Ara, canviarem el format de compressi贸 i utilitzarem el Zlib.

Anirem al fitxer de configuraci贸 de MySQL que la ruta 茅s `/etc/my.cnf` i modificarem el parmetre de la compressi贸 de MyRocks (RocksDB), aplicant-ho al dimoni del MySQL (mysqld, servei que utilitza).

```
# nano /etc/my.cnf
```
Modificarem els parmetres `bottommost_compression` i `compression` seguit especificant el m猫tode de `compressi贸` que volguem. Cada parmetre finalitza amb un `;` i l'altre comen莽a despr茅s d'aquest `;`
```
[mysqld]
rocksdb_default_cf_options=bottommost_compression=kZlibCompression;compression=kZlibCompression
```
<details open>
<summary><b>Canviar el format de compressi贸 a Zlib</b></summary>
<img src="captures/default_kzlib.png">
</details>

Seguit reiniciarem el servei de MySQL. Si ens dona un error o el status est en vermell 茅s que algun parmetre est malament configurat.
```
# systemctl restart mysqld && systemctl status mysqld
```
<details open>
<summary><b>Reiniciar i comprovar el servei de MySQLD</b></summary>
<img src="captures/systemctl_restart_status.png">
</details>

Ara des de MySQL comprovarem que a partir d'ara el format de compressi贸 茅s el que hem configurat (Zlib).
Farem servir la seg眉ent sent猫ncia de consulta utilitzada anteriorment.
```
mysql> SELECT *
FROM information_schema.rocksdb_cf_options
WHERE option_type LIKE '%compression%'
AND cf_name='default';
```
<details open>
<summary><b>Compressi贸 Zlib per defecte</b></summary>
<img src="captures/compresion_zlib.png">
</details>

#####  ZSTD 
Ara, canviarem el format de compressi贸 i utilitzarem el ZSTD.

Anirem al fitxer de configuraci贸 de MySQL que la ruta 茅s `/etc/my.cnf` i modificarem el parmetre de la compressi贸 de MyRocks (RocksDB), aplicant-ho al dimoni del MySQL (mysqld, servei que utilitza).

```
# nano /etc/my.cnf
```
Modificarem els parmetres `bottommost_compression` i `compression` seguit especificant el m猫tode de `compressi贸` que volguem. Cada parmetre finalitza amb un `;` i l'altre comen莽a despr茅s d'aquest `;`
```
[mysqld]
rocksdb_default_cf_options=bottommost_compression=kZSTD;compression=kZSTD
```
<details open>
<summary><b>Canviar el format de compressi贸 a ZSTD</b></summary>
<img src="captures/default_zstd.png">
</details>

Seguit reiniciarem el servei de MySQL. Si ens dona un error o el status est en vermell 茅s que algun parmetre est malament configurat.
```
# systemctl restart mysqld && systemctl status mysqld
```
<details open>
<summary><b>Reiniciar i comprovar el servei de MySQLD</b></summary>
<img src="captures/systemctl_restart_status.png">
</details>

Ara des de MySQL comprovarem que a partir d'ara el format de compressi贸 茅s el que hem configurat (ZSTD).
Farem servir la seg眉ent sent猫ncia de consulta utilitzada anteriorment.
```
mysql> SELECT *
FROM information_schema.rocksdb_cf_options
WHERE option_type LIKE '%compression%'
AND cf_name='default';
```
<details open>
<summary><b>Compressi贸 ZSTD per defecte</b></summary>
<img src="captures/compresion_zstd.png">
</details>

#####  SENSE COMPRESSI 
Ara, deshabilitarem la compressi贸 per defecte.

Anirem al fitxer de configuraci贸 de MySQL que la ruta 茅s `/etc/my.cnf` i modificarem el parmetre de la compressi贸 de MyRocks (RocksDB), aplicant-ho al dimoni del MySQL (mysqld, servei que utilitza).

```
# nano /etc/my.cnf
```
Modificarem els parmetres `bottommost_compression` i `compression` seguit especificant el m猫tode de `compressi贸` que volguem. Cada parmetre finalitza amb un `;` i l'altre comen莽a despr茅s d'aquest `;`
```
[mysqld]
rocksdb_default_cf_options=bottommost_compression=kDisableCompressionOption;compression=kNoCompression
```
<details open>
<summary><b>Deshabilitar la compressi贸</b></summary>
<img src="captures/default_nocompression.png">
</details>

Seguit reiniciarem el servei de MySQL. Si ens dona un error o el status est en vermell 茅s que algun parmetre est malament configurat.
```
# systemctl restart mysqld && systemctl status mysqld
```
<details open>
<summary><b>Reiniciar i comprovar el servei de MySQLD</b></summary>
<img src="captures/systemctl_restart_status.png">
</details>

Ara des de MySQL comprovarem que a partir d'ara no utilitza cap format de compressi贸.
Farem servir la seg眉ent sent猫ncia de consulta utilitzada anteriorment.
```
mysql> SELECT *
FROM information_schema.rocksdb_cf_options
WHERE option_type LIKE '%compression%'
AND cf_name='default';
```
<details open>
<summary><b>No utilitza Compressi贸 per defecte</b></summary>
<img src="captures/compresion_no.png">
</details>

#####  LZ4 (Per Defecte) 
Per defecte si no configurem la opci贸 de compressi贸 utilitza aquesta.

Llavors treiem la linea configurada anteriorment i tindriem el format LZ4 per defecte.

En cas de que al instal路lar el MyRocks hi hagi un altre format per defecte, el podrem especificar en el MySQL tamb茅.

```
# nano /etc/my.cnf
```
```
[mysqld]
rocksdb_default_cf_options=bottommost_compression=kLZ4Compression;compression=kLZ4Compression
```
<details open>
<summary><b>Canviar el m茅tode de compressi贸 a LZ4 en cas de tenir un altre per defecte</b></summary>
<img src="captures/compress_def_lz4.png">
</details>

Seguit reiniciarem el servei de MySQL. Si ens dona un error o el status est en vermell 茅s que algun parmetre est malament configurat.
```
# systemctl restart mysqld && systemctl status mysqld
```
<details open>
<summary><b>Reiniciar i comprovar el servei de MySQLD</b></summary>
<img src="captures/systemctl_restart_status.png">
</details>

Ara des de MySQL comprovarem que a partir d'ara utilitza LZ4 per defecte.
```
mysql> mysql> SELECT *
FROM information_schema.rocksdb_cf_options
WHERE option_type LIKE '%compression%'
AND cf_name='default';
```
<details open>
<summary><b>Format de compressi贸 LZ4 per defecte.</b></summary>
<img src="captures/kLZ4_default.png">
</details>











