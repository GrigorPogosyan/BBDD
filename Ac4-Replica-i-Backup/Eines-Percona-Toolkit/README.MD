# √ös de Percona Toolkit <img align="right" width="185" src="../imatges/percona_toolkit_logo.png"/>

## Connexi√≥ per SSH al Sistema (Opcional)
Si tenim instal¬∑lat SSH en la nostra m√†quina `master`. Accedirem en remot per una correcta administraci√≥ del Sistema.
```
ssh usuarimaquina@ip
```
<details open>
<summary><b>Connexi√≥ per SSH al Master</b></summary>
<img src="captures/ssh.png">
</details>

## Introducci√≥
Les `Percona Toolkit` s√≥n un conjunt d'eines avan√ßades en la linea de comandes, creat per `Percona` i utilitzada per realitzar una gran varietat de tasques d'administraci√≥ sobre els nostres servidors de base de dades.

Aquestes eines s√≥n les alternatives als scripts privat que fa la gent per administrar la seva BD, la difer√®ncia es que les eines de Percona han sigut desenvolupades profesionalment, ben testejades i documentades.

‚ö†Ô∏èS'ha fet aquesta gu√≠a, despr√©s de montar el sistema de replicaci√≥ `Master` - `Slave` provinent del apartat anterior de [Configuraci√≥-Sistema-Replica](https://github.com/GrigorPogosyan/M02-Base-de-Dades/tree/main/Ac4-Replica-i-Backup/Configuracio-Sistema-Replica )‚ö†Ô∏è

A continuaci√≥ utilitzarem les seg√ºents eines:
  > - pt-table-checksum : Aquesta eina verifica la integritat de la replicaci√≥ del MySQL, relitza una verificaci√≥ de coher√®ncia de la replicaci√≥ mitjan√ßant unes comandes que utilitzarem en el Master. pt-table-checksum detecta r√®pliques autom√†ticament i es connecta a elles, moltes vegades aix√≤ pot fallar i s'ha d'especificar la m√†quina slave, es connectar√† als slaves autom√†ticament si tenim el mateix compte (un compte d'administraci√≥ per exemple) amb el mateix password i es connectar√† a tots els slaves que trobi.

  > - pt-table-sync : Aquesta eina ve lligat amb l'apartat anterior, un cop que sabem que tenim una inconsist√®ncia de dades entre `Master` i `Slave`, aquesta eina serveix per sincronitzar les dades de la taula amb el par√†metre `--sync-to-master` que veurem m√©s endavant podem dir que el Slave sincronitzi les dades que t√© el `Master`, i d'aquesta manera solucionariem el problema de la inconsist√®ncia de dades.

## Percona Toolkit
Comen√ßarem a instal¬∑lar aquestes eines en el `Master`. (Hem de tenir el repositori afegit i habilitat (en teoria ho tenim degut a que hem hagut de fer aquests pasos al instal¬∑lar Percona MySQL 8.0))
```
# yum install percona-toolkit -y
```
<details open>
<summary><b>Instal¬∑larem les eines Percona Toolkit</b></summary>
<img src="captures/install_percona_toolkit.png">
</details>

Si despr√©s d'intentar instal¬∑lar les eines estem en un entorn RHEL85, i tenim problemes amb els paquests, podem provar aquestes comandes.
```
# dnf clean all
# rm -frv /var/cache/dnf
# subscription-manager refresh
# dnf update
```

Un cop el tenim instal¬∑lat. Haurem de fer una configuraci√≥ d'usuaris. Haurem de crear un usuari espec√≠fic, que utilitzarem nom√©s quan utilitzem aquestes eines de Percona. Podem crear el compte `'percona_user'@'192.168.151.143'` on el host √©s el IP del Servidor de Master, o el compte `'percona_user'@'%'` hem de triar un dels dos, en aquest cas optar√© per la primera. El crearem en el `Master` i aquest replicar√† cap al `Slave` i aquests dos tindran el mateix compte. I li donarem tots els privilegis.
```
mysql> CREATE USER 'percona_user'@'192.168.151.143' IDENTIFIED BY 'Sox2020$';
mysql> GRANT ALL PRIVILEGES ON *.* TO 'percona_user'@'192.168.151.143';
mysql> FLUSH PRIVILEGES;
```
<details open>
<summary><b>Creaci√≥ del compte amb privilegis per utilitzar-lo per les eines de Percona Toolkit</b></summary>
<img src="captures/percona_user.png">
</details>

Ara, farem un `pt-table-checksum` amb la base de dades de `Sakila` que el tenim en el `Master` i replicat en el `Slave`. Si no s'especifica l'usuari i password del `Slave`, ell per defecte  busca tots els slave recursivament que depenen d'aquell master amb el mateix usuari del par√†metre `-u` i pwd `-p`, per aix√≤ hem creat el mateix usuari en el `MASTER` i `SLAVE` perqu√® si especifiquem el del Master ell ja busca tots els Slaves que tingui, per√≤ si especifiquem l'usuari del Master i aquest no est√† en el Slave, no el trobar√† autom√†ticament i tamb√© haurem d'especificar les credencials del Slave.

En la sent√®ncia tamb√© especificarem el par√†metre `--no-check-binlog-format` perqu√® el format de Row per defecte √©s MIXED, i el Checksum el comprova utlitzant Statement, llavors per evitar problemes evitem que miri el format del binlog.

Si no li posem el par√†metre --databases=sakila, verificar√† totes les taules en totes les bases de dades.

üü¢ Manera 1: Mateix usuari en el Master i Slave i que es connecti autom√†ticament als Slaves que trobi el script.:
```
# pt-table-checksum -u percona_user -pSox2020$ -h 192.168.151.143 --no-check-binlog-format --databases=sakila
```
<details open>
<summary><b>pt-table-checksum manera 1</b></summary>
<img src="captures/pt_table_checksum.png">
</details>

üü¢ Manera 2: No tenim els usuaris replicats, i volem utilitzar un usuari espec√≠fic per el Master, i un usuari espec√≠fic al Slave. I per connectar-nos al M√†ster estarem utilitzant els valors de `-u`,`-p` i `-h`, i per al Slave `--slave-user=percona_user` i `--slave-password=PWD`:
```
# pt-table-checksum -u root -pSox2020$ -h localhost --no-check-binlog-format --slave-user=percona_user --slave-password=Sox2020$ --databases=sakila;
```
<details open>
<summary><b>pt-table-checksum manera 2</b></summary>
<img src="captures/pt_table_checksum2.png">
</details>

Com podem veure no tenim cap problema perqu√® en la columna `DIFF` √©s 0, llavors anirem a provocar una inconsist√®ncia de dades en el Slave per veure com ens ho mostraria el `pt-table-checksum`.

Modificarem la taula de actor de la BD de Sakila en el Slave i veurem amb una select que tenim dades diferents:
```
mysql > UPDATE sakila.actor SET first_name = "Hola";

mysql > SELECT * FROM sakila.actor LIMIT 5;
```
<details open>
<summary><b>Provocar una inconsist√®ncia i veure que tenim dades diferents</b></summary>
<img src="captures/difference_actor.png">
</details>

Ara, en teoria, si tornem a fer el `pt-table-checksum` en el `Master` que √©s on tenim instal¬∑lat el percona toolkit, ens hauria de dir que tenim una difer√®ncia en la taula d'Actor entre el `Master i Slave`.
```
# pt-table-checksum -u percona_user -pSox2020$ -h 192.168.151.143 --no-check-binlog-format --databases=sakila;
```
<details open>
<summary><b>Veure que el pt-table-checksum ha trobat una inconsist√®ncia de dades</b></summary>
<img src="captures/diff_checksum.png">
</details>

Clar, ara si volem arreglar les difer√®ncies com ho arreglem? Doncs per aix√≤ est√† la eina `pt-table-sync` que va lligat amb l'anterior eina, perqu√® l'anterior eina et diu la inconsist√®ncia i aquesta te'l soluciona. 

Amb aquesta eina abans mirarem quins canvis t√© el `Slave` a difer√®ncia del Master, i sincronitzarem el les dades de la BD de Sakila del `Master` cap al Slave. Amb el par√†metre `--print` ens dir√† els canvis que far√† el Master cap al Slave, ens mostrar√† que far√† `REPLACE INTO` i el valor nou que posar√†.
```
# pt-table-sync --sync-to-master h=192.168.151.142,u=replication,p=Sox2020$,P=3306 --databases=sakila --tables=actor --print
```
<details open>
<summary><b>Veure els canvis que es far√† en el Slave per tornar a tenir consist√®ncia</b></summary>
<img src="captures/print_changes.png">
</details>

Un cop veiem els canvis i estem segurs de que volem fer aquests canvis. Amb la seg√ºent sent√®ncia, estarem sincronitzant els canvis que ha de tenir el `Slave` del `Master`. Ignorarem les claus foraneas, i que no verifiqui la integritat de les taules dels quan dep√©n, aix√≤ pot ser perill√≥s, per√≤ si sabem que en el `Master` les dades s√≥n correctes i tenen integritat, doncs el el `Slave` podrem ignorar les claus foraneas, ja que sabem que les dades que ens venen "d'adalt" s√≥n integres.
```
# pt-table-sync --sync-to-master h=192.168.151.142,u=percona_user,p=Sox2020$,P=3306 --databases=sakila --tables=actor --no-check-child-tables --no-foreign-key-checks --execute
```
<details open>
<summary><b>Executar la sincronitzaci√≥ del Master cap al Slave per tornar a tenir consist√®ncia</b></summary>
<img src="captures/execute_sync.png">
</details>

Si no ignorem les <em>taules filles</em> **( --no-check-child-tables)** i el check de les <em>foreign key</em> **(--no-foreign-key-checks)** ens donar√† el seg√ºent error:
```
Cannot delete or update a parent row: a foreign key constraint fails (`sakila`.`film_actor`, CONSTRAINT `fk_film_actor_actor` FOREIGN KEY (`actor_id`) REFERENCES `actor` (`actor_id`) ON DELETE RESTRICT ON UPDATE CASCADE) [for Statement "REPLACE INTO `sakila`.`actor`(`actor_id`, `first_name`, `last_name`, `last_update`) VALUES ('1', 'PENELOPE', 'GUINESS', '2006-02-15 04:34:33') /*percona-toolkit src_db:sakila src_tbl:actor src_dsn:P=3306,h=192.168.151.143,p=...,u=replication dst_db:sakila dst_tbl:actor dst_dsn:P=3306,h=192.168.151.142,p=...,u=replication lock:1 transaction:1 changing_src:1 replicate:0 bidirectional:0 pid:29192 user:root host:localhost.localdomain*/"] at line 10950 while doing sakila.actor on 192.168.151.142
```

Ara, un cop hem sincronitzat el `Slave` al `Master` degut a la inconsist√®ncia que teniem, si tornem a fer el `Checksum` nos ens hauria de sortir cap difer√®ncia de dades.
```
# pt-table-checksum -u percona_user -pSox2020$ -h 192.168.151.143 --no-check-binlog-format --databases=sakila;
```
<details open>
<summary><b>Veure que despr√©s de la sincronitzaci√≥ no tenim cap inconsist√®ncia</b></summary>
<img src="captures/no_inconsistence_after_sync.png">
</details>

I ara, podem tornar a fer consultes sobre aquesta taula i veurem que a difer√®ncia d'abans tenim les dades iguals en ambd√≥s servidors:
```
mysql> SELECT * FROM sakila.actor LIMIT 5;
```
<details open>
<summary><b>Comprovar que tenim les dades iguals despr√©s de fer el Sync</b></summary>
<img src="captures/no_inconsistence_after_sync2.png">
</details>

Si tenim problemes o volem afegir-hi par√†metres, podem consultar la documentaci√≥ que ve quan instal¬∑lem les percona toolkit.

Si volem consultar la documentaci√≥ de l'eina `pt-table-checksum`
```
# perldoc /usr/bin/pt-table-checksum
```

Si volem consultar la documentaci√≥ de l'eina `pt-table-sync`
```
# perldoc /usr/bin/pt-table-sync
```